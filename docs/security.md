# Security

Porterminal exposes a terminal over the network. This document covers security considerations and the password protection feature.

## When to Use Password Protection

Use password if your screen can be exposed to others (they can see the QR code).

If you're alone, the URL itself is sufficient protection. The tunnel URL is randomly generated by Cloudflare with high entropy - it's unguessable and not indexed anywhere. Without seeing your screen, no one can discover the URL.

## Password Protection

Password protection adds authentication to prevent unauthorized access.

### Enabling Password Protection

**For current session only:**
```bash
ptn -p
```
You'll be prompted to enter a password. This password is required for all connecting devices.

**Enable by default:**
```bash
ptn -dp
```
This toggles `security.require_password` in your config file. Run again to disable.

**Via config file:**
```yaml
security:
  require_password: true
  max_auth_attempts: 5
```

### How It Works

```
┌─────────────────────────────────────────────────────────────┐
│                        SERVER                                │
│  1. Startup: prompt for password                            │
│  2. Hash with bcrypt, store in memory                       │
│  3. On WebSocket connect: require auth message              │
│  4. Validate password against hash                          │
│  5. Allow/reject connection                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        CLIENT                                │
│  1. Connect to WebSocket                                    │
│  2. Receive "auth_required" message                         │
│  3. Show password prompt (or use saved password)            │
│  4. Send password to server                                 │
│  5. On success: save to localStorage, proceed               │
│  6. On failure: show error, allow retry                     │
└─────────────────────────────────────────────────────────────┘
```

### Password is Per-Session

The password is **disposable** - it exists only for the current server session:

| Location | What's Stored | Lifetime |
|----------|---------------|----------|
| Server memory | bcrypt hash | Until server stops (never saved to disk) |
| Browser localStorage | Plaintext password | Until cleared or auth fails |

**Key points:**
- Server restart = new password required
- Password is never written to any file
- Each session can have a different password
- Browser remembers password for convenience (per-origin)

### Retry Limits

Failed authentication attempts are tracked per WebSocket connection:

- Default: 5 attempts before disconnect
- Configurable via `security.max_auth_attempts`
- After max attempts, **server shuts down** to prevent brute force attacks

When this happens, you'll see:
```
SECURITY WARNING
Max authentication attempts exceeded.
Your URL may have been leaked. Investigate before restarting.
```

This means someone has your URL (likely social engineering - they saw your screen). Stop and investigate before restarting.

### WebSocket Protocol

**Server → Client:**
```json
{"type": "auth_required"}
{"type": "auth_success"}
{"type": "auth_failed", "attempts_remaining": 4, "error": "Invalid password"}
```

**Client → Server:**
```json
{"type": "auth", "password": "..."}
```

### Close Codes

| Code | Meaning |
|------|---------|
| 4001 | Authentication failed or required |

## Security Model

### With Password Protection

- URL provides access to the login prompt only
- Password required to access terminal
- Password validated against bcrypt hash (server-side)
- Failed attempts are rate-limited per connection
- Password is disposable - changes each server session

### Without Password Protection

- URL is the only authentication
- Anyone with the link has full terminal access

## Best Practices

1. **Use password** (`-p`) if your screen can be exposed to others
2. **Stop the server** when not in use (`Ctrl+C`)
3. **Use `--no-tunnel`** for local network only
4. **Don't run as admin/root** - server warns if elevated

## Troubleshooting

**Connection fails?** Cloudflare tunnel sometimes blocks connections. Restart the server (`Ctrl+C`, then `ptn`) to get a fresh tunnel URL.

## Cloudflare Access Integration

For team deployments, you can add an additional layer with [Cloudflare Access](https://developers.cloudflare.com/cloudflare-one/policies/access/):

1. Cloudflare Access authenticates users at the edge
2. Only authenticated traffic reaches your server
3. User identity available via `cf-access-authenticated-user-email` header
4. Each user gets isolated sessions

This can be combined with password protection for defense in depth.

See [configuration.md](configuration.md#cloudflare-access-integration) for setup details.
